jQuery(document).ready(function ($) {
  $(".form-cek-resi").on("submit", function (e) {
    e.preventDefault();

    // Ambil nomor AWB dari input
    var awbNumber = $("#tracking").val();

    $("#modalResiContent").html(
      '<div class="modal-header"><h1 class="modal-title fs-5" id="modalResiLabel">Memuat data</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center" id="modalResiBody"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>'
    );

    // Lakukan validasi nomor AWB (sesuai kebutuhan)
    if (!awbNumber) {
      $("#modalResiContent").html(
        '<div class="modal-header"><h1 class="modal-title fs-5" id="modalResiLabel">No. AWB Tidak boleh kosong</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center" id="modalResiBody">Anda harus memasukkan nomor AWB.</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>'
      );
      return;
    }

    // Kirim permintaan Ajax
    $.ajax({
      type: "POST",
      url: sweetaddons.ajaxurl, // Variabel global WordPress untuk URL Ajax
      data: {
        action: "get_post_by_awb",
        awbNumber: awbNumber,
      },
      success: function (response) {
        // Tampilkan data post dalam modal
        $("#modalResiContent").html(response);
        // $("#modalResi").modal("show");
      },
      error: function (error) {
        console.log(error);
      },
    });
  });

  $("#form-cek-ongkir").on("submit", function (e) {
    e.preventDefault(); // Mencegah formulir untuk melakukan submit secara langsung
    $("#modalOngkir").modal("show");
    // Dapatkan data dari formulir
    var dariAlamat = $('select[name="dari"]').val();
    var tujuanAlamat = $('select[name="tujuan"]').val();
    var berat = $('input[name="berat"]').val();

    if (!(dariAlamat && tujuanAlamat && berat)) {
      $("#modalOngkirContent").html(
        '<div class="modal-header"><h1 class="modal-title fs-5" id="modalResiLabel">Lengkapi data</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center" id="modalResiBody">Anda harus memasukkan data dari, tujuan, dan berat</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>'
      );
      return;
    }
    // Lakukan Ajax request
    $.ajax({
      type: "POST",
      url: sweetaddons.ajaxurl, // Ganti dengan URL yang sesuai
      data: {
        action: "get_ongkir", // Tambahkan aksi yang sesuai di sisi server
        dari: dariAlamat,
        tujuan: tujuanAlamat,
        berat: berat,
      },
      success: function (response) {
        // Tanggapan dari server
        console.log(response);
        // Lakukan sesuatu dengan data ongkir yang diperoleh
        // Misalnya, tampilkan data di elemen HTML tertentu
        // Assuming capitalize is a custom function
        function capitalize(str) {
          return str.replace(/\b\w/g, function (char) {
            return char.toUpperCase();
          });
        }

        $("#modalOngkirContent").html(
          '<div class="modal-header"><h1 class="modal-title fs-5" id="modalResiLabel">Hasil Cek Ongkir</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="modalResiBody"><b>Dari : </b> ' +
            capitalize(dariAlamat.toLowerCase()) +
            "<br><b>Tujuan : </b>" +
            capitalize(tujuanAlamat.toLowerCase()) +
            "<br><b>Berat : </b>" +
            berat +
            "kg <br><b>Ongkir : Rp. " +
            response +
            '</b></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>'
        );
      },
      error: function (xhr, status, error) {
        // Tanggapan kesalahan
        console.error(error);
      },
    });
  });

  function updateClock() {
    var now = new Date();
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var seconds = now.getSeconds();

    // Tambahkan nol di depan jika jam, menit, atau detik kurang dari 10
    hours = hours < 10 ? "0" + hours : hours;
    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;

    // Format waktu: HH:MM:SS
    var timeString = hours + ":" + minutes + ":" + seconds;

    // Tampilkan waktu di elemen dengan id "clock"
    $(".real-time-clock").html(timeString);

    // Update waktu setiap 1 detik
    setTimeout(updateClock, 1000);
  }

  // Panggil fungsi pertama kali
  updateClock();
  // Memeriksa apakah browser mendukung geolocation

  // Jika tombol #tombol-check ditekan, lakukan simpan data dengan wp json
  $("#tombol-check").on("click", function () {
    const video = $("#video")[0];
    // Menggunakan variabel untuk melacak apakah foto sudah diambil atau belum
    let isPhotoTaken = false;
    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then(function (stream) {
        video.srcObject = stream;
      })
      .catch(function (error) {
        console.error("Error accessing the camera:", error);
      });

    $("#form-cek-ongkir").on("submit", function (e) {
      e.preventDefault(); // Mencegah formulir untuk melakukan submit secara langsung
      $("#modalOngkir").modal("show");
      // Dapatkan data dari formulir
      var dariAlamat = $('input[name="dari"]').val();
      var tujuanAlamat = $('input[name="tujuan"]').val();
      var berat = $('input[name="berat"]').val();

      console.log(dariAlamat, tujuanAlamat, berat);
      if (!(dariAlamat && tujuanAlamat && berat)) {
        $("#modalOngkirContent").html(
          '<div class="modal-header"><h1 class="modal-title fs-5" id="modalResiLabel">Lengkapi data</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center" id="modalResiBody">Anda harus memasukkan data dari, tujuan, dan berat</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>'
        );
        return;
      }
      // Lakukan Ajax request
      $.ajax({
        type: "POST",
        url: sweetaddons.ajaxurl, // Ganti dengan URL yang sesuai
        data: {
          action: "get_ongkir", // Tambahkan aksi yang sesuai di sisi server
          dari: dariAlamat,
          tujuan: tujuanAlamat,
          berat: berat,
        },
        success: function (response) {
          // Tanggapan dari server
          console.log(response);
          // Lakukan sesuatu dengan data ongkir yang diperoleh
          // Misalnya, tampilkan data di elemen HTML tertentu
          $("#modalOngkirContent").html(
            '<div class="modal-header"><h1 class="modal-title fs-5" id="modalResiLabel">Hasil Cek Ongkir</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="modalResiBody">Dari <b>' +
              dariAlamat +
              "</b><br>Ke <b>" +
              tujuanAlamat +
              "</b><br>Berat <b>" +
              berat +
              "kg</b> <br>Ongkir <b>Rp. " +
              response +
              '</b></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>'
          );
        },
        error: function (xhr, status, error) {
          // Tanggapan kesalahan
          console.error(error);
        },
      });
    });
  });
});

jQuery(document).ready(function ($) {
  // Memeriksa cookie untuk shift yang disimpan
  var selectedShift = getCookie("selectedShift");
  if (selectedShift) {
    $("#shiftDropdown").val(selectedShift);
  }

  // Menghandle perubahan shift pada dropdown
  $("#shiftDropdown").on("change", function () {
    selectedShift = $(this).val();
    setCookie("selectedShift", selectedShift, 7); // Menyimpan shift ke cookie
  });

  // Menghandle klik pada tombol check-in
  $("#checkInBtn").on("click", function () {
    handleAbsen("checkin");
  });

  // Menghandle klik pada tombol check-out
  $("#checkOutBtn").on("click", function () {
    handleAbsen("checkout");
  });

  // Fungsi untuk menangani logika absensi
  function handleAbsen(action) {
    if (selectedShift) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;

          // Mengirim data absen ke server atau menyimpan di post type
          $.ajax({
            url: sweetaddons.ajaxurl,
            type: "POST",
            data: {
              action: "handle_absen",
              shift: selectedShift,
              action_type: action,
              latitude: latitude,
              longitude: longitude,
            },
            success: function (response) {
              alert("Absen berhasil.");
            },
            error: function (error) {
              alert("Terjadi kesalahan saat absen.");
            },
          });
        });
      } else {
        alert("Browser tidak mendukung geolocation.");
      }
    } else {
      alert("Pilih shift terlebih dahulu.");
    }
  }

  // Fungsi untuk mendapatkan nilai cookie
  function getCookie(name) {
    var match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
    return match ? match[2] : null;
  }

  // Fungsi untuk menetapkan nilai cookie
  function setCookie(name, value, days) {
    var expires = "";
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + value + expires + "; path=/";
  }
});

// Mengecek apakah data sudah ada di local storage
if (!localStorage.getItem("provincesData")) {
  // Jika tidak ada, maka ambil data dari URL
  fetch("https://aadiityaak.github.io/api-wilayah-indonesia/api/provinces.json")
    .then((response) => response.json())
    .then((data) => {
      // Mengonversi data menjadi string JSON
      const jsonString = JSON.stringify(data);

      // Menyimpan string JSON ke local storage dengan kunci tertentu
      localStorage.setItem("provincesData", jsonString);

      console.log("Data berhasil diambil dan disimpan di local storage.");
    })
    .catch((error) => console.error("Terjadi kesalahan:", error));
} else {
  console.log("Data sudah ada di local storage.");
}
